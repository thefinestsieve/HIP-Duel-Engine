namespace = hde_battle

### SETUP
## 0-99 reserved
# These events are only required if there aren't already existing events to plug into
# hde_battle.0		Begin the chain, triggered from on_actions
# hde_battle.1		Pass along event, starts the actual fight

### FLAVOR EVENTS
# These come in two varieties: Winner first and loser first
# If winner first, the loser sends the appropriate handler event back to the winner
# If loser first, the winner calls the appropriate bounce event on the loser
# If sent to the winner, winner = ROOT and loser = FROMFROM
# If sent to the loser, loser = ROOT and winner = FROM

## INITIAL FLAVOR
## 100-199 reserved
# 100-149: Winner first versions
# hde_battle.100	Winner decides
# hde_battle.101	Loser decides
# hde_battle.102	Winner ran away
# hde_battle.103	Loser ran away
# 150-199: Loser first versions

## FIRST CLASH FLAVOR
## 200-299 reserved
# 200-249: Winner first versions
# 250-299: Loser first versions

## COMBAT FLAVOR
## 300-399 reserved
# 300-349: Winner first versions
# 350-399: Loser first versions

## OUTCOME FLAVOR
## 400-499 reserved
# 400-449: Winner first versions
# 450-499: Loser first versions

## FAILURE FLAVOR
# Not sure if necessary yet

### SETUP EVENTS
character_event = {
    id = hde_battle.0
    hide_window = yes
    
    is_triggered_only = yes
    
    trigger = {
        # Avoid crossing targets
        FROM = {
            liege = {
                OR = {
                    any_realm_character = {
                        in_battle = yes
                        at_location = ROOT
                        NOT = { has_character_modifier = battlefield_fight }
                    }
					AND = {
						in_battle = yes
						at_location = ROOT
						NOT = { has_character_modifier = battlefield_fight }
					}
                }
            }
        }
        NOT = { has_character_modifier = battlefield_fight }
    }
    
    weight_multiplier = {
        days = 1
        modifier = {
            factor = 1.5
            trait = trained_warrior
        }
        modifier = {
            factor = 1.75
            trait = skilled_warrior
        }
        modifier = {
            factor = 2
            trait = master_warrior
        }
        modifier = {
            factor = 3
            trait = duelist
        }
        modifier = {
            factor = 1.5
            trait = brave
        }
        modifier = {
            factor = 0.5
            trait = craven
        }
    }
    
    immediate = {
        # Target lock
        add_character_modifier = {
            name = battlefield_fight
            duration = 20
        }
        FROM = {
            liege = {
                if = {
                    limit = {
                        NOT = {
                            in_battle = yes
                            at_location = ROOT
                            NOT = { has_character_modifier = battlefield_fight }
                        }
						any_realm_character = {
							in_battle = yes
							at_location = ROOT
							NOT = { has_character_modifier = battlefield_fight }
						}
                    }
                    random_realm_character = {
                        limit = {
                            in_battle = yes
                            at_location = ROOT
                            NOT = { has_character_modifier = battlefield_fight }
                        }
                        opinion = { who = ROOT modifier = opinion_battle_duel_target }
                        reverse_opinion = { who = ROOT modifier = opinion_battle_duel_target }
                        add_character_modifier = {
                            name = battlefield_fight
                            duration = 20
                        }
                    }
                    ROOT = { set_character_flag = duel_engaged }
                }
                if = {
                    limit = {
                        NOT = {
                            any_realm_character = {
                                in_battle = yes
                                at_location = ROOT
                                NOT = { has_character_modifier = battlefield_fight }
                            }
                        }
						in_battle = yes
						at_location = ROOT
						NOT = { has_character_modifier = battlefield_fight }
                    }
                    opinion = { who = ROOT modifier = opinion_battle_duel_target }
                    reverse_opinion = { who = ROOT modifier = opinion_battle_duel_target }
                    add_character_modifier = {
                        name = battlefield_fight
                        duration = 20
                    }
                    ROOT = { set_character_flag = duel_engaged }
                }
                if = {
                    limit = {
						NOT = { ROOT = { has_character_flag = duel_engaged } }
						any_realm_character = {
							in_battle = yes
							at_location = ROOT
							NOT = { has_character_modifier = battlefield_fight }
						}
						in_battle = yes
						at_location = ROOT
						NOT = { has_character_modifier = battlefield_fight }
					}
                    random_list = {
                        10 = {
                            opinion = { who = ROOT modifier = opinion_battle_duel_target }
                            reverse_opinion = { who = ROOT modifier = opinion_battle_duel_target }
                            add_character_modifier = {
                                name = battlefield_fight
                                duration = 20
                            }
                        }
                        90 = {
                            random_realm_character = {
                                limit = {
                                    in_battle = yes
                                    at_location = ROOT
                                    NOT = { has_character_modifier = battlefield_fight }
                                }
                                opinion = { who = ROOT modifier = opinion_battle_duel_target }
                                reverse_opinion = { who = ROOT modifier = opinion_battle_duel_target }
                                add_character_modifier = {
                                    name = battlefield_fight
                                    duration = 20
                                }
                            }
                        }
                    }
                }
            }
        }
        clr_character_flag = duel_engaged
		FROM = {
            liege = {
                random_realm_character = {
                    limit = { has_opinion_modifier = { who = ROOT modifier = opinion_battle_duel_target } }
					hidden_tooltip = { character_event = { id = hde_battle.1 } }
                }
                if = {
                    limit = { has_opinion_modifier = { who = ROOT modifier = opinion_battle_duel_target } }
                    hidden_tooltip = { character_event = { id = hde_battle.1 } }
                }
            }
        }
    }
    
    option = {
        name = OK
    }
}

# Passing it right along...
character_event = {
	id = hde_battle.1
	hide_window = yes

	is_triggered_only = yes
	
	immediate = {
		# Remove initial targeting information
		remove_opinion = { who = FROM modifier = opinion_battle_duel_target }
		reverse_remove_opinion = { who = FROM modifier = opinion_battle_duel_target }
		
		# Set duel type
		set_character_flag = flag_battlefield_duel
		FROM = { set_character_flag = flag_battlefield_duel }
		
		# Start this thing!
		hidden_tooltip = { e_rebels = { holder_scope = { character_event = { id = hde_core.0 } } } }
	}
	
	option = {
		name = OK
	}
}

### FLAVOR EVENTS
## Initial Flavor
## Winner First
# Winner attacks or not!
character_event = {
	id = hde_battle.100
	desc = hde_battle.100.desc
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war
	hide_from = yes
	
	is_triggered_only = yes
	
	option = {
		name = hde_battle.100.a # Charge!
		FROMFROM = { # Send to loser
			character_event = { id = hde_battle.101 tooltip = hde_battle.101.tt }
		}
	}
	
	option = {
		name = hde_battle.100.b # NOPE!
		hidden_tooltip = {
			FROMFROM = { # Send to loser
				character_event = { id = hde_battle.102 }
			}
		}
	}
}
# Loser decides
character_event = {
	id = hde_battle.101
	desc = hde_battle.101.desc
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	option = {
		name = hde_battle.101.a # Let's fight!
		FROM = { # Send next handler to winner
			character_event = { id = hde_core.3 tooltip = hde_core.3.tt }
		}
	}
	
	option = {
		name = hde_battle.101.b # I'm outta here!
		hidden_tooltip = {
			FROM = { # Send to winner
				character_event = { id = hde_battle.103 }
			}
		}
	}
}
# Winner chickens out
character_event = {
	id = hde_battle.102
	desc = hde_battle.102.desc
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	option = {
		name = hde_battle.102.a # Yeah, he'd better run!
		hidden_tooltip = {
			FROM = { # Send winner the cleanup event
				character_event = { id = hde_core.9 }
			}
		}
	}
}
# Loser chickens out
character_event = {
	id = hde_battle.103
	desc = hde_battle.103.desc
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	option = {
		name = hde_battle.103.a # Yeah, that's what I thought...
		hidden_tooltip = {
			FROM = { # Send loser the cleanup event
				character_event = { id = hde_core.9 }
			}
		}
	}
}

## Loser First
# Note that the first four events just reuse the same localization from the winner events.
# You can't always do this (beware of screwing up the scopes!) but when you can it's handy.
# The first event is the one where the scopes are different (becomes FROM instead of FROMFROM)
# Loser attacks or not!
character_event = {
	id = hde_battle.150
	desc = hde_battle.100.desc
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war
	hide_from = yes
	
	is_triggered_only = yes
	
	option = {
		name = hde_battle.100.a # Charge!
		FROM = { # Send to winner
			character_event = { id = hde_battle.151 tooltip = hde_battle.101.tt }
		}
	}
	
	option = {
		name = hde_battle.100.b # NOPE!
		hidden_tooltip = {
			FROM = { # Send to winner
				character_event = { id = hde_battle.152 }
			}
		}
	}
}
# Winner decides
character_event = {
	id = hde_battle.151
	desc = hde_battle.101.desc
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	option = {
		name = hde_battle.101.a # Let's fight!
		FROM = { # Send next handler bounce event to loser
			character_event = { id = hde_core.4 tooltip = hde_core.4.tt }
		}
	}
	
	option = {
		name = hde_battle.101.b # I'm outta here!
		hidden_tooltip = {
			FROM = { # Send to loser
				character_event = { id = hde_battle.153 }
			}
		}
	}
}
# Loser chickens out
character_event = {
	id = hde_battle.152
	desc = hde_battle.102.desc
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	option = {
		name = hde_battle.102.a # Yeah, he'd better run!
		hidden_tooltip = {
			FROM = { # Send loser the cleanup event
				character_event = { id = hde_core.9 }
			}
		}
	}
}
# Winner chickens out
character_event = {
	id = hde_battle.153
	desc = hde_battle.103.desc
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	option = {
		name = hde_battle.103.a # Yeah, that's what I thought...
		hidden_tooltip = {
			FROM = { # Send winner the cleanup event
				character_event = { id = hde_core.9 }
			}
		}
	}
}
