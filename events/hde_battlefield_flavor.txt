namespace = hde_battle

### SETUP
## 0-99 reserved
# These events are only required if there aren't already existing events to plug into
# hde_battle.0		Begin the chain, triggered from on_actions
# hde_battle.1		Pass along event, starts the actual fight

### FLAVOR EVENTS
# Each of these need to have two header events, one for Winner = ROOT and one for Loser = ROOT
# Opponent is FROMFROM in former, FROM in latter
# But all subsequent events in the chain are interchangeable as long as they 

# These come in two varieties: Winner first and loser first
# If winner first, the loser sends the appropriate handler event back to the winner
# If loser first, the winner calls the appropriate bounce event on the loser
# If sent to the winner, winner = ROOT and loser = FROMFROM
# If sent to the loser, loser = ROOT and winner = FROM

# Localization for flavor events should be written in the roles of Aggressor and Defender
# Localization is interchangeable except for the initial event, where the Winner's first event needs to reference FROMFROM as the opponent and the Loser's first event needs to reference FROM as the opponent

## INITIAL FLAVOR
## 100-199 reserved

## SIZING UP FLAVOR
## 200-299 reserved

## COMBAT FLAVOR
## 300-399 reserved

## OUTCOME FLAVOR
## 400-499 reserved

## FAILURE FLAVOR
# Not sure if necessary yet

### SETUP EVENTS
character_event = {
    id = hde_battle.0
    hide_window = yes
    
    is_triggered_only = yes
	
	# Filter out characters who are blind!
    
    trigger = {
        # Avoid crossing targets
        FROM = {
            liege = {
                OR = {
                    any_realm_character = {
                        in_battle = yes
                        at_location = ROOT
                        NOT = { has_character_modifier = battlefield_fight }
                    }
					AND = {
						in_battle = yes
						at_location = ROOT
						NOT = { has_character_modifier = battlefield_fight }
					}
                }
            }
        }
        NOT = { has_character_modifier = battlefield_fight }
    }
    
    weight_multiplier = {
        days = 1
        modifier = {
            factor = 1.5
            trait = trained_warrior
        }
        modifier = {
            factor = 1.75
            trait = skilled_warrior
        }
        modifier = {
            factor = 2
            trait = master_warrior
        }
        modifier = {
            factor = 3
            trait = duelist
        }
        modifier = {
            factor = 1.5
            trait = brave
        }
        modifier = {
            factor = 0.5
            trait = craven
        }
    }
    
    immediate = {
        # Target lock
        add_character_modifier = {
            name = battlefield_fight
            duration = 20
        }
        FROM = {
            liege = {
                if = {
                    limit = {
                        NOT = {
                            in_battle = yes
                            at_location = ROOT
                            NOT = { has_character_modifier = battlefield_fight }
                        }
						any_realm_character = {
							in_battle = yes
							at_location = ROOT
							NOT = { has_character_modifier = battlefield_fight }
						}
                    }
                    random_realm_character = {
                        limit = {
                            in_battle = yes
                            at_location = ROOT
                            NOT = { has_character_modifier = battlefield_fight }
                        }
                        opinion = { who = ROOT modifier = opinion_battle_duel_target }
                        reverse_opinion = { who = ROOT modifier = opinion_battle_duel_target }
                        add_character_modifier = {
                            name = battlefield_fight
                            duration = 20
                        }
                    }
                    ROOT = { set_character_flag = duel_engaged }
                }
                if = {
                    limit = {
                        NOT = {
                            any_realm_character = {
                                in_battle = yes
                                at_location = ROOT
                                NOT = { has_character_modifier = battlefield_fight }
                            }
                        }
						in_battle = yes
						at_location = ROOT
						NOT = { has_character_modifier = battlefield_fight }
                    }
                    opinion = { who = ROOT modifier = opinion_battle_duel_target }
                    reverse_opinion = { who = ROOT modifier = opinion_battle_duel_target }
                    add_character_modifier = {
                        name = battlefield_fight
                        duration = 20
                    }
                    ROOT = { set_character_flag = duel_engaged }
                }
                if = {
                    limit = {
						NOT = { ROOT = { has_character_flag = duel_engaged } }
						any_realm_character = {
							in_battle = yes
							at_location = ROOT
							NOT = { has_character_modifier = battlefield_fight }
						}
						in_battle = yes
						at_location = ROOT
						NOT = { has_character_modifier = battlefield_fight }
					}
                    random_list = {
                        10 = {
                            opinion = { who = ROOT modifier = opinion_battle_duel_target }
                            reverse_opinion = { who = ROOT modifier = opinion_battle_duel_target }
                            add_character_modifier = {
                                name = battlefield_fight
                                duration = 20
                            }
                        }
                        90 = {
                            random_realm_character = {
                                limit = {
                                    in_battle = yes
                                    at_location = ROOT
                                    NOT = { has_character_modifier = battlefield_fight }
                                }
                                opinion = { who = ROOT modifier = opinion_battle_duel_target }
                                reverse_opinion = { who = ROOT modifier = opinion_battle_duel_target }
                                add_character_modifier = {
                                    name = battlefield_fight
                                    duration = 20
                                }
                            }
                        }
                    }
                }
            }
        }
        clr_character_flag = duel_engaged
		FROM = {
            liege = {
                random_realm_character = {
                    limit = { has_opinion_modifier = { who = ROOT modifier = opinion_battle_duel_target } }
					hidden_tooltip = { character_event = { id = hde_battle.1 } }
                }
                if = {
                    limit = { has_opinion_modifier = { who = ROOT modifier = opinion_battle_duel_target } }
                    hidden_tooltip = { character_event = { id = hde_battle.1 } }
                }
            }
        }
    }
    
    option = {
        name = OK
    }
}

# Passing it right along...
character_event = {
	id = hde_battle.1
	hide_window = yes

	is_triggered_only = yes
	
	immediate = {
		# Remove initial targeting information
		remove_opinion = { who = FROM modifier = opinion_battle_duel_target }
		reverse_remove_opinion = { who = FROM modifier = opinion_battle_duel_target }
		
		# Set duel type
		set_character_flag = flag_battlefield_duel
		FROM = { set_character_flag = flag_battlefield_duel }
		
		# Start this thing!
		hidden_tooltip = { e_rebels = { holder_scope = { character_event = { id = hde_core.0 } } } }
	}
	
	option = {
		name = OK
	}
}

### FLAVOR EVENTS
#####################
## Initial Flavor
## I'd like to give cowards a chance to become brave if they choose to fight.
## Or at least a chance to lose craven.
# Note that all events in the sequence are interchangeable except the first, which may require its own localization
# Aggressor attacks or not! (ROOT = Winner)
character_event = {
	id = hde_battle.100
	desc = hde_battle.100.desc
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war
	hide_from = yes
	
	is_triggered_only = yes
	
	option = {
		name = hde_battle.100.a # Charge!
		ai_chance = {
			factor = 100
			modifier = {
				factor = 3
				trait = poor_warrior
			}
			modifier = {
				factor = 5
				trait = trained_warrior
			}
			modifier = {
				factor = 7
				trait = skilled_warrior
			}
			modifier = {
				factor = 9
				trait = master_warrior
			}
			modifier = {
				factor = 3
				trait = duelist
			}
			modifier = {
				factor = 10
				trait = brave
			}
			modifier = {
				factor = 5
				trait = proud
			}
			modifier = {
				factor = 1.5
				trait = wroth
			}
			modifier = {
				factor = 1.5
				trait = strong
			}
		}
		
		FROMFROM = { # Send to loser
			character_event = { id = hde_battle.102 tooltip = hde_battle.102.tt }
		}
	}
	
	option = {
		name = hde_battle.100.b # NOPE!
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2
				FROMFROM = { trait = poor_warrior }
			}
			modifier = {
				factor = 3
				FROMFROM = { trait = trained_warrior }
			}
			modifier = {
				factor = 4
				FROMFROM = { trait = skilled_warrior }
			}
			modifier = {
				factor = 5
				FROMFROM = { trait = master_warrior }
			}
			modifier = {
				factor = 3
				FROMFROM = { trait = duelist }
			}
			modifier = {
				factor = 2
				FROMFROM = { trait = strong }
			}
			modifier = {
				factor = 10
				trait = craven
			}
			modifier = {
				factor = 2
				trait = paranoid
			}
			modifier = {
				factor = 2
				trait = weak
			}
			modifier = {
				factor = 2
				trait = dwarf
			}
			modifier = {
				factor = 2
				trait = hunchback
			}
			modifier = {
				factor = 2
				trait = leper
			}
			modifier = {
				factor = 2
				trait = wounded
				NOT = { trait = lunatic }
				NOT = { trait = brave }
				NOT = { trait = proud }
				NOT = { trait = wroth }
			}
			modifier = {
				factor = 4
				trait = maimed
				NOT = { trait = lunatic }
				NOT = { trait = brave }
				NOT = { trait = proud }
				NOT = { trait = wroth }
			}
			modifier = {
				factor = 10
				trait = blinded
				NOT = { trait = lunatic }
				NOT = { trait = brave }
				NOT = { trait = proud }
				NOT = { trait = wroth }
			}
		}

		if = {
			limit = {
				FROMFROM = {
					NOT = { trait = poor_warrior }
					NOT = { trait = trained_warrior }
					NOT = { trait = skilled_warrior }
					NOT = { trait = master_warrior }
				}
				NOT = { trait = craven }
			}
			random = {
				chance = 25
				add_trait = craven
			}
		}
		if = {
			limit = {
				FROMFROM = {
					trait = poor_warrior
				}
				NOT = { trait = craven }
			}
			random = {
				chance = 20
				add_trait = craven
			}
		}
		if = {
			limit = {
				FROMFROM = {
					trait = trained_warrior
				}
				NOT = { trait = craven }
			}
			random = {
				chance = 15
				add_trait = craven
			}
		}
		if = {
			limit = {
				FROMFROM = {
					trait = skilled_warrior
				}
				NOT = { trait = craven }
			}
			random = {
				chance = 10
				add_trait = craven
			}
		}
		if = {
			limit = {
				FROMFROM = {
					trait = master_warrior
				}
				NOT = { trait = craven }
			}
			random = {
				chance = 5
				add_trait = craven
			}
		}
		morale = -0.1
		hidden_tooltip = {
			FROMFROM = { # Send to defender
				character_event = { id = hde_battle.103 }
			}
		}
	}
}
# Aggressor attacks or not! (ROOT = Loser)
character_event = {
	id = hde_battle.101
	desc = hde_battle.100.desc
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war
	hide_from = yes
	
	is_triggered_only = yes
	
	option = {
		name = hde_battle.100.a # Charge!
		ai_chance = {
			factor = 100
			modifier = {
				factor = 3
				trait = poor_warrior
			}
			modifier = {
				factor = 5
				trait = trained_warrior
			}
			modifier = {
				factor = 7
				trait = skilled_warrior
			}
			modifier = {
				factor = 9
				trait = master_warrior
			}
			modifier = {
				factor = 3
				trait = duelist
			}
			modifier = {
				factor = 10
				trait = brave
			}
			modifier = {
				factor = 5
				trait = proud
			}
			modifier = {
				factor = 1.5
				trait = wroth
			}
			modifier = {
				factor = 1.5
				trait = strong
			}
		}

		FROM = { # Send to winner
			character_event = { id = hde_battle.102 tooltip = hde_battle.102.tt }
		}
	}
	
	option = {
		name = hde_battle.100.b # NOPE!
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2
				FROM = { trait = poor_warrior }
			}
			modifier = {
				factor = 3
				FROM = { trait = trained_warrior }
			}
			modifier = {
				factor = 4
				FROM = { trait = skilled_warrior }
			}
			modifier = {
				factor = 5
				FROM = { trait = master_warrior }
			}
			modifier = {
				factor = 3
				FROM = { trait = duelist }
			}
			modifier = {
				factor = 2
				FROM = { trait = strong }
			}
			modifier = {
				factor = 10
				trait = craven
			}
			modifier = {
				factor = 2
				trait = paranoid
			}
			modifier = {
				factor = 2
				trait = weak
			}
			modifier = {
				factor = 2
				trait = dwarf
			}
			modifier = {
				factor = 2
				trait = hunchback
			}
			modifier = {
				factor = 2
				trait = leper
			}
			modifier = {
				factor = 2
				trait = wounded
				NOT = { trait = lunatic }
				NOT = { trait = brave }
				NOT = { trait = proud }
				NOT = { trait = wroth }
			}
			modifier = {
				factor = 4
				trait = maimed
				NOT = { trait = lunatic }
				NOT = { trait = brave }
				NOT = { trait = proud }
				NOT = { trait = wroth }
			}
			modifier = {
				factor = 10
				trait = blinded
				NOT = { trait = lunatic }
				NOT = { trait = brave }
				NOT = { trait = proud }
				NOT = { trait = wroth }
			}
		}
		
		if = {
			limit = {
				FROM = {
					NOT = { trait = poor_warrior }
					NOT = { trait = trained_warrior }
					NOT = { trait = skilled_warrior }
					NOT = { trait = master_warrior }
				}
				NOT = { trait = craven }
			}
			random = {
				chance = 25
				add_trait = craven
			}
		}
		if = {
			limit = {
				FROM = { trait = poor_warrior }
				NOT = { trait = craven }
			}
			random = {
				chance = 20
				add_trait = craven
			}
		}
		if = {
			limit = {
				FROM = { trait = trained_warrior }
				NOT = { trait = craven }
			}
			random = {
				chance = 15
				add_trait = craven
			}
		}
		if = {
			limit = {
				FROM = { trait = skilled_warrior }
				NOT = { trait = craven }
			}
			random = {
				chance = 10
				add_trait = craven
			}
		}
		if = {
			limit = {
				FROM = { trait = master_warrior }
				NOT = { trait = craven }
			}
			random = {
				chance = 5
				add_trait = craven
			}
		}
		morale = -0.1
		hidden_tooltip = {
			FROM = { # Send to defender
				character_event = { id = hde_battle.103 }
			}
		}
	}
}
# Defender fights or not!
character_event = {
	id = hde_battle.102
	desc = hde_battle.102.desc
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	option = {
		name = hde_battle.102.a # Let's fight!
		ai_chance = {
			factor = 100
			modifier = {
				factor = 3
				trait = poor_warrior
			}
			modifier = {
				factor = 5
				trait = trained_warrior
			}
			modifier = {
				factor = 7
				trait = skilled_warrior
			}
			modifier = {
				factor = 9
				trait = master_warrior
			}
			modifier = {
				factor = 3
				trait = duelist
			}
			modifier = {
				factor = 10
				trait = brave
			}
			modifier = {
				factor = 5
				trait = proud
			}
			modifier = {
				factor = 1.5
				trait = wroth
			}
			modifier = {
				factor = 1.5
				trait = strong
			}
		}
		
		if = {
			limit = { has_character_flag = flag_duel_loser }
			FROM = { # Send handler to Winner
				character_event = { id = hde_core.3 tooltip = hde_core.3.tt }
			}
		}
		if = {
			limit = { has_character_flag = flag_duel_winner }
			FROM = { # Send handler bounce to Loser
				character_event = { id = hde_core.4 tooltip = hde_core.4.tt }
			}
		}
	}
	
	option = {
		name = hde_battle.102.b # I'm outta here!
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2
				FROM = { trait = poor_warrior }
			}
			modifier = {
				factor = 3
				FROM = { trait = trained_warrior }
			}
			modifier = {
				factor = 4
				FROM = { trait = skilled_warrior }
			}
			modifier = {
				factor = 5
				FROM = { trait = master_warrior }
			}
			modifier = {
				factor = 3
				FROM = { trait = duelist }
			}
			modifier = {
				factor = 2
				FROM = { trait = strong }
			}
			modifier = {
				factor = 10
				trait = craven
			}
			modifier = {
				factor = 2
				trait = paranoid
			}
			modifier = {
				factor = 2
				trait = weak
			}
			modifier = {
				factor = 2
				trait = dwarf
			}
			modifier = {
				factor = 2
				trait = hunchback
			}
			modifier = {
				factor = 2
				trait = leper
			}
			modifier = {
				factor = 2
				trait = wounded
				NOT = { trait = lunatic }
				NOT = { trait = brave }
				NOT = { trait = proud }
				NOT = { trait = wroth }
			}
			modifier = {
				factor = 4
				trait = maimed
				NOT = { trait = lunatic }
				NOT = { trait = brave }
				NOT = { trait = proud }
				NOT = { trait = wroth }
			}
			modifier = {
				factor = 10
				trait = blinded
				NOT = { trait = lunatic }
				NOT = { trait = brave }
				NOT = { trait = proud }
				NOT = { trait = wroth }
			}
		}
		
		if = {
			limit = {
				FROM = {
					NOT = { trait = poor_warrior }
					NOT = { trait = trained_warrior }
					NOT = { trait = skilled_warrior }
					NOT = { trait = master_warrior }
				}
				NOT = { trait = craven }
			}
			random = {
				chance = 25
				add_trait = craven
			}
		}
		if = {
			limit = {
				FROM = { trait = poor_warrior }
				NOT = { trait = craven }
			}
			random = {
				chance = 20
				add_trait = craven
			}
		}
		if = {
			limit = {
				FROM = { trait = trained_warrior }
				NOT = { trait = craven }
			}
			random = {
				chance = 15
				add_trait = craven
			}
		}
		if = {
			limit = {
				FROM = { trait = skilled_warrior }
				NOT = { trait = craven }
			}
			random = {
				chance = 10
				add_trait = craven
			}
		}
		if = {
			limit = {
				FROM = { trait = master_warrior }
				NOT = { trait = craven }
			}
			random = {
				chance = 5
				add_trait = craven
			}
		}
		morale = -0.1
		hidden_tooltip = {
			FROM = { # Send to aggressor
				character_event = { id = hde_battle.104 }
			}
		}
	}
}
# Aggressor chickens out
character_event = {
	id = hde_battle.103
	desc = hde_battle.103.desc
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	option = {
		name = hde_battle.103.a # Yeah, he'd better run!

		morale = 0.1
		hidden_tooltip = {
			FROM = { # Time for cleanup
				character_event = { id = hde_core.9 }
			}
		}
	}
}
# Defender chickens out
character_event = {
	id = hde_battle.104
	desc = hde_battle.104.desc
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	option = {
		name = hde_battle.104.a # Yeah, that's what I thought...

		morale = 0.1
		hidden_tooltip = {
			FROM = { # Time for cleanup
				character_event = { id = hde_core.9 }
			}
		}
	}
}

#####################
## Sizing Up Flavor
## Winner First
# Going to add support here for "tired" versions by tagging characters who've been through the loop more than once
# Aggressor circles... (ROOT = Winner)
character_event = {
	id = hde_battle.200
	desc = hde_battle.200.desc
	picture = GFX_evt_duel0
	border = GFX_event_normal_frame_war
	hide_from = yes
	
	option = {
		name = hde_battle.200.a
		
		hidden_tooltip = {
			FROMFROM = { # Send to Loser
				character_event = { id = hde_battle.201 }
			}
		}
	}
}
# Aggressor circles... (ROOT = Loser)
character_event = {
	id = hde_battle.201
	desc = hde_battle.200.desc
	picture = GFX_evt_duel0
	border = GFX_event_normal_frame_war
	hide_from = yes
	
	option = {
		name = hde_battle.200.a
		
		hidden_tooltip = {
			FROM = { # Send to Winner
				character_event = { id = hde_battle.201 }
			}
		}
	}
}
# Defender circles...
character_event = {
	id = hde_battle.202
	desc = hde_battle.202.desc
	picture = GFX_evt_duel0
	border = GFX_event_normal_frame_war
	hide_from = yes
	
	option = {
		name = hde_battle.202.a
		if = {
			limit = { has_character_flag = flag_duel_loser }
			FROM = { # Send handler to Winner
				character_event = { id = hde_core.5 tooltip = hde_core.5.tt }
			}
		}
		if = {
			limit = { has_character_flag = flag_duel_winner }
			FROM = { # Send handler bounce to Loser
				character_event = { id = hde_core.6 tooltip = hde_core.6.tt }
			}
		}
	}
}
